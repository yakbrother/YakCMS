---
import { parseISO, format } from 'date-fns';

interface Props {
  initialDate?: string;
  initialTime?: string;
  timezone?: string;
}

const { 
  initialDate = '', 
  initialTime = '', 
  timezone = Intl.DateTimeFormat().resolvedOptions().timeZone 
} = Astro.props;
---

<div 
  class="post-scheduler"
  x-data="{
    publishDate: initialDate,
    publishTime: initialTime,
    timezone,
    status: 'draft',
    showCalendar: false,
    
    get formattedDateTime() {
      if (!this.publishDate || !this.publishTime) return '';
      const date = new Date(`${this.publishDate}T${this.publishTime}`);
      return format(date, 'PPpp');
    },
    
    isValidSchedule() {
      if (!this.publishDate || !this.publishTime) return false;
      const scheduleDate = new Date(`${this.publishDate}T${this.publishTime}`);
      return scheduleDate > new Date();
    }
  }"
>
  <div class="bg-card rounded-lg border-2 border-default p-6">
    <h3 class="text-xl font-semibold text-heading mb-6">Publishing Schedule</h3>

    <!-- Status Selection -->
    <div class="mb-6">
      <label class="block text-body font-medium mb-2">Status</label>
      <div class="flex gap-4">
        <label class="inline-flex items-center">
          <input
            type="radio"
            name="status"
            value="draft"
            x-model="status"
            class="text-accent focus:ring-accent"
          />
          <span class="ml-2 text-body">Draft</span>
        </label>
        <label class="inline-flex items-center">
          <input
            type="radio"
            name="status"
            value="published"
            x-model="status"
            class="text-accent focus:ring-accent"
          />
          <span class="ml-2 text-body">Publish Now</span>
        </label>
        <label class="inline-flex items-center">
          <input
            type="radio"
            name="status"
            value="scheduled"
            x-model="status"
            class="text-accent focus:ring-accent"
          />
          <span class="ml-2 text-body">Schedule</span>
        </label>
      </div>
    </div>

    <!-- Schedule Controls -->
    <div x-show="status === 'scheduled'" x-transition>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-body font-medium mb-2">Date</label>
          <input
            type="date"
            x-model="publishDate"
            min={new Date().toISOString().split('T')[0]}
            class="w-full px-4 py-2 border-2 border-default rounded-lg bg-peach text-body focus:border-focus focus:ring-2 focus:ring-accent/20 transition-colors"
          />
        </div>
        <div>
          <label class="block text-body font-medium mb-2">Time</label>
          <input
            type="time"
            x-model="publishTime"
            class="w-full px-4 py-2 border-2 border-default rounded-lg bg-peach text-body focus:border-focus focus:ring-2 focus:ring-accent/20 transition-colors"
          />
        </div>
      </div>

      <div class="mb-4">
        <label class="block text-body font-medium mb-2">Timezone</label>
        <select
          x-model="timezone"
          class="w-full px-4 py-2 border-2 border-default rounded-lg bg-peach text-body focus:border-focus focus:ring-2 focus:ring-accent/20 transition-colors"
        >
          {Intl.supportedValuesOf('timeZone').map((tz) => (
            <option value={tz} selected={tz === timezone}>{tz}</option>
          ))}
        </select>
      </div>

      <!-- Schedule Preview -->
      <div 
        class="mt-4 p-4 bg-peach rounded-lg"
        x-show="publishDate && publishTime"
      >
        <p class="text-body">
          Will be published:
          <span 
            x-text="formattedDateTime"
            class="font-medium"
          ></span>
        </p>
      </div>

      <!-- Validation Message -->
      <div 
        x-show="!isValidSchedule() && publishDate && publishTime"
        class="mt-4 p-4 bg-accent/10 text-accent rounded-lg"
      >
        Please select a future date and time.
      </div>
    </div>
  </div>

  <!-- Hidden inputs for form submission -->
  <input type="hidden" name="publishStatus" x-model="status">
  <input type="hidden" name="publishDate" x-model="publishDate">
  <input type="hidden" name="publishTime" x-model="publishTime">
  <input type="hidden" name="timezone" x-model="timezone">
</div>

<style>
  .post-scheduler {
    @apply font-sans;
  }
</style>
